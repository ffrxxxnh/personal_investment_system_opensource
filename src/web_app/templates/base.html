<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Investment System{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body class="bg-gray-100 min-h-screen font-sans">
    <!-- Demo Mode Banner -->
    {% if is_demo_mode %}
    <div class="bg-gradient-to-r from-amber-500 to-orange-500 text-black py-2 px-4 text-center relative"
        id="demo-banner">
        <div class="container mx-auto flex items-center justify-center gap-4 flex-wrap">
            <span
                class="inline-flex items-center bg-black text-amber-400 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">
                <i class="fas fa-flask mr-1"></i>{{ _('Demo Mode') }}
            </span>
            <span class="text-black/80 text-sm">
                {{ _("You're exploring with sample data.") }}
            </span>
            <a href="{{ url_for('onboarding.upload') }}"
                class="inline-flex items-center bg-black text-white px-4 py-1.5 rounded-full text-sm font-medium hover:bg-gray-800 transition">
                <i class="fas fa-upload mr-2"></i>{{ _('Upload Your Data') }}
            </a>
            <button onclick="dismissDemoBanner()"
                class="absolute right-4 text-black/60 hover:text-black transition text-xl" title="{{ _('Dismiss') }}">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <script>
        function dismissDemoBanner() {
            document.getElementById('demo-banner').style.display = 'none';
            sessionStorage.setItem('demoBannerDismissed', 'true');
        }
        if (sessionStorage.getItem('demoBannerDismissed') === 'true') {
            document.addEventListener('DOMContentLoaded', function () {
                var banner = document.getElementById('demo-banner');
                if (banner) banner.style.display = 'none';
            });
        }
    </script>
    {% endif %}
    <nav class="bg-gradient-to-r from-blue-700 via-indigo-700 to-purple-700 text-white shadow-xl">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-3">
                <a href="/" class="text-xl font-bold flex items-center hover:opacity-90 transition">
                    <i class="fas fa-chart-line mr-2"></i> WealthOS
                </a>
                <div class="hidden md:flex space-x-4 items-center">
                    <a href="/" class="px-3 py-2 rounded-lg hover:bg-white/10 transition">{{ _('Dashboard') }}</a>
                    <a href="{{ url_for('data_workbench.index') }}"
                        class="px-3 py-2 rounded-lg hover:bg-white/10 transition">{{ _('Data Workbench') }}</a>
                    <a href="{{ url_for('logic_studio.index') }}"
                        class="px-3 py-2 rounded-lg hover:bg-white/10 transition">{{ _('Logic Studio') }}</a>
                    <a href="{{ url_for('integrations.dashboard') }}"
                        class="px-3 py-2 rounded-lg hover:bg-white/10 transition">{{ _('Integrations') }}</a>

                    <!-- Health Check Dropdown -->
                    <div class="relative group">
                        <button class="px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center">
                            <span>{{ _('Health Check') }}</span>
                            <i class="fas fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        <div
                            class="absolute top-full left-0 mt-1 w-48 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                            <a href="{{ url_for('dashboard.data_quality_health_check') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-blue-50 rounded-t-lg transition">
                                <i class="fas fa-heartbeat mr-2 text-red-500"></i> Data Quality
                            </a>
                            <a href="{{ url_for('reports.cashflow_parity') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-green-50 rounded-b-lg transition">
                                <i class="fas fa-balance-scale mr-2 text-green-600"></i> Parity Check
                            </a>
                        </div>
                    </div>

                    <!-- Reports Dropdown -->
                    <div class="relative group">
                        <button class="px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center">
                            <span>{{ _('Reports') }}</span>
                            <i class="fas fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        <div
                            class="absolute top-full left-0 mt-1 w-48 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                            <a href="{{ url_for('reports.thermometer') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-blue-50 rounded-t-lg transition">
                                <i class="fas fa-thermometer-half mr-2 text-orange-600"></i> Market
                            </a>
                            <a href="{{ url_for('reports.cashflow') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition">
                                <i class="fas fa-money-bill-wave mr-2 text-teal-600"></i> Cash Flow
                            </a>
                            <a href="{{ url_for('reports.portfolio') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition">
                                <i class="fas fa-briefcase mr-2 text-blue-600"></i> Portfolio
                            </a>
                            <a href="{{ url_for('reports.compass') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition">
                                <i class="fas fa-compass mr-2 text-purple-600"></i> Compass
                            </a>
                            <a href="{{ url_for('reports.attribution') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 transition">
                                <i class="fas fa-project-diagram mr-2 text-indigo-600"></i> Attribution
                            </a>
                            <a href="{{ url_for('reports.annual') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-purple-50 transition">
                                <i class="fas fa-chart-pie mr-2 text-pink-600"></i> Annual
                            </a>
                            <a href="{{ url_for('simulation.index') }}"
                                class="block px-4 py-3 text-gray-700 hover:bg-red-50 rounded-b-lg transition">
                                <i class="fas fa-microchip mr-2 text-red-600"></i> Simulation
                            </a>
                        </div>
                    </div>


                    <!-- Cache Status Indicator -->
                    {% if cache_info %}
                    <div class="flex items-center space-x-2 bg-white/10 px-3 py-1.5 rounded-full text-xs">
                        <span
                            class="w-2 h-2 rounded-full {% if cache_info.status == 'valid' %}bg-green-400{% else %}bg-yellow-400{% endif %}"></span>
                        <span class="text-white/80" title="Last updated: {{ cache_info.last_updated }}">
                            Cache: {{ cache_info.age_minutes }}m
                        </span>
                        <button onclick="refreshCache()" class="text-white/70 hover:text-white transition ml-1"
                            title="Refresh Cache">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    {% endif %}

                    <!-- Language Selector -->
                    <div class="relative group ml-4">
                        <button class="px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center">
                            <i class="fas fa-globe mr-1"></i>
                            <span class="uppercase">{{ get_locale() }}</span>
                            <i class="fas fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        <div
                            class="absolute top-full right-0 mt-1 w-32 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 overflow-hidden">
                            <a href="{{ url_for('main.set_language', lang_code='en') }}"
                                class="block px-4 py-2 text-gray-700 hover:bg-blue-50 transition border-b border-gray-100">
                                English
                            </a>
                            <a href="{{ url_for('main.set_language', lang_code='zh') }}"
                                class="block px-4 py-2 text-gray-700 hover:bg-blue-50 transition">
                                中文
                            </a>
                        </div>
                    </div>

                    {% if current_user.is_authenticated %}
                    <div class="flex items-center space-x-3 ml-4 pl-4 border-l border-white/20">
                        <span class="text-white/80 text-sm"><i class="fas fa-user mr-1"></i> {{ current_user.id
                            }}</span>
                        <a href="{{ url_for('auth.logout') }}"
                            class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm font-medium transition">{{
                            _('Logout') }}</a>
                    </div>
                    {% else %}
                    <a href="{{ url_for('auth.login') }}"
                        class="bg-white text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-medium transition ml-4">{{
                        _('Login') }}</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-6">
            {% for category, message in messages %}
            <div
                class="p-4 rounded-md shadow-sm mb-2 {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <footer class="bg-gray-800 text-gray-400 py-6 mt-auto">
        <div class="container mx-auto px-4 text-center text-sm">
            &copy; 2025 Personal Investment System. All rights reserved.
        </div>
    </footer>
    <script>
        async function refreshCache() {
            const btn = document.querySelector('button[onclick="refreshCache()"] i');
            if (btn) btn.classList.add('fa-spin');

            try {
                const response = await fetch('/api/cache/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Failed to refresh cache: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error refreshing cache:', error);
                alert('Error refreshing cache. Check console for details.');
            } finally {
                if (btn) btn.classList.remove('fa-spin');
            }
        }
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>