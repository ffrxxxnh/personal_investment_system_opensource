{% extends "base.html" %}

{% block title %}{{ _('Data Workbench') }} - WealthOS{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wizard.css') }}">

<div class="page-content wizard-container">
    <input type="hidden" id="importSessionId" value="">
    <input type="hidden" id="currentStep" value="1">

    <!-- STEP 1: SELECTION SCREEN -->
    <div id="step1" class="wizard-panel">
        <div class="wizard-header">
            <h1 class="wizard-title-lg">{{ _('Data Workbench') }}</h1>
            <p class="wizard-subtitle">{{ _('Choose data to import into your portfolio') }}</p>
        </div>

        <div class="option-grid">
            <!-- Pending Import (Yellow Card) -->
            <div class="option-card pending" onclick="resumePendingImport()">
                <div class="pending-badge">{{ _('Pending') }}</div>
                <div class="card-icon-wrapper">
                    <i class="fas fa-history"></i>
                </div>
                <div class="card-content">
                    <h3>{{ _('Resume pending import') }}</h3>
                    <p>{{ _('Continue your last import session exactly where you left off.') }}</p>
                </div>
            </div>

            <!-- Transactions -->
            <div class="option-card standard" onclick="selectImportType('transactions', this)">
                <div class="card-icon-wrapper">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-content">
                    <h3>{{ _('Import Transactions') }}</h3>
                    <p>{{ _('Upload trade logs via CSV or connect directly to broker APIs.') }}</p>
                </div>
            </div>

            <!-- Holdings -->
            <div class="option-card standard" onclick="selectImportType('holdings', this)">
                <div class="card-icon-wrapper">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div class="card-content">
                    <h3>{{ _('Import Holdings') }}</h3>
                    <p>{{ _('Update current portfolio positions, real estate, and private equity.') }}</p>
                </div>
            </div>

            <!-- Accounts -->
            <div class="option-card standard" onclick="selectImportType('accounts', this)">
                <div class="card-icon-wrapper">
                    <i class="fas fa-university"></i>
                </div>
                <div class="card-content">
                    <h3>{{ _('Import Accounts') }}</h3>
                    <p>{{ _('Bulk configure multiple banking and custodial accounts.') }}</p>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div style="margin-top: 40px; border-top: 1px solid var(--wizard-border); padding-top: 20px;">
            <div style="text-align: center;">
                <button onclick="toggleHistory()" class="btn btn-outline btn-sm">
                    <i class="fas fa-history"></i> {{ _('View Import History') }}
                </button>
            </div>

            <div id="historyPanel" class="hidden mt-4"
                style="background: var(--bg-container-inset); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--wizard-border);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <h3 style="font-size: 0.875rem; font-weight: 700; text-transform: uppercase;">{{ _('Recent Imports')
                        }}</h3>
                    <button onclick="toggleHistory()" style="background:none; border:none; cursor:pointer;"><i
                            class="fas fa-times"></i></button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table-clean w-100" style="font-size: 0.875rem;">
                        <thead>
                            <tr>
                                <th>{{ _('Batch') }}</th>
                                <th>{{ _('Status') }}</th>
                                <th>{{ _('Date') }}</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: var(--space-8);">
            <a href="#"
                style="color: var(--wizard-text-sub); font-size: 0.875rem; display: inline-flex; align-items: center; gap: 6px;">
                <i class="far fa-question-circle"></i> {{ _('Need help with data formats? View Documentation') }}
            </a>
        </div>
    </div>

    <!-- WIZARD FLOW CONTAINER (Steps 2-5) -->
    <div id="wizard-flow" class="hidden">

        <!-- Progress Line Tracker -->
        <div class="progress-container">
            <div class="progress-line-bg"></div>
            <div class="progress-line-active" id="progressLineActive" style="width: 0%;"></div>

            <div class="progress-steps">
                <!-- Step 1 (Source) -->
                <div class="progress-step completed">
                    <div class="step-circle"><i class="fas fa-check"></i></div>
                    <div class="step-label">{{ _('Source') }}</div>
                </div>

                <!-- Step 2 (Upload) -->
                <div class="progress-step active" id="progress-step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">{{ _('Upload') }}</div>
                </div>

                <!-- Step 3 (Map) -->
                <div class="progress-step" id="progress-step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">{{ _('Map') }}</div>
                </div>

                <!-- Step 4 (Review) -->
                <div class="progress-step" id="progress-step-4">
                    <div class="step-circle">4</div>
                    <div class="step-label">{{ _('Review') }}</div>
                </div>

                <!-- Step 5 (Done) -->
                <div class="progress-step" id="progress-step-5">
                    <div class="step-circle">5</div>
                    <div class="step-label">{{ _('Done') }}</div>
                </div>
            </div>
        </div>

        <!-- STEP 2: UPLOAD -->
        <div id="step2" class="wizard-panel">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                <div>
                    <h2 class="wizard-title-lg" style="font-size: 1.5rem;">{{ _('Upload Workflow') }}</h2>
                    <p class="wizard-subtitle" style="margin-bottom: 0;">{{ _('Step 2 of 5: Import your CSV data') }}
                    </p>
                </div>
            </div>

            <div style="text-align: center;">
                <div class="mode-toggle">
                    <button class="toggle-btn active" onclick="switchUploadMode('file')">{{ _('Upload CSV') }}</button>
                    <button class="toggle-btn" onclick="switchUploadMode('paste')">{{ _('Copy & Paste') }}</button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 20px;">
                <!-- Left: Configuration -->
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <label class="form-label" style="font-weight: 600; margin-bottom: 8px; display: block;">{{
                            _('Column Separator') }}</label>
                        <select id="columnSeparator" class="form-select"
                            style="width: 100%; padding: 8px; border: 1px solid var(--wizard-border); border-radius: var(--radius-md);">
                            <option value=",">{{ _('Comma (,)') }}</option>
                            <option value=";">{{ _('Semicolon (;)') }}</option>
                            <option value="\t">{{ _('Tab') }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label" style="font-weight: 600; margin-bottom: 8px; display: block;">{{
                            _('Target Account') }}</label>
                        <select id="targetAccount" class="form-select"
                            style="width: 100%; padding: 8px; border: 1px solid var(--wizard-border); border-radius: var(--radius-md);">
                            <option value="multi">{{ _('Multi-account import') }}</option>
                            <option value="savings">{{ _('Personal Savings - *8842') }}</option>
                            <option value="invest">{{ _('Investment Portfolio - *9921') }}</option>
                        </select>
                    </div>
                </div>

                <!-- Right: Dropzone -->
                <div>
                    <div class="upload-zone" id="dropzone" onclick="document.getElementById('wizardFileInput').click()">
                        <input type="file" id="wizardFileInput" accept=".csv,.xls,.xlsx" class="hidden"
                            onchange="handleFileSelect(event)" style="display: none;">
                        <div style="font-size: 3rem; color: var(--wizard-primary); margin-bottom: 1rem;">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h3 style="font-weight: 600; margin-bottom: 4px;">{{ _('Click to upload or drag and drop') }}
                        </h3>
                        <p style="color: var(--wizard-text-sub); font-size: 0.875rem;">{{ _('SVG, PNG, JPG or GIF (max.
                            800x400px)') }}</p>
                        <div style="margin-top: 1rem;">
                            <span
                                style="background: white; border: 1px solid var(--wizard-border); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: var(--wizard-text-sub);">
                                {{ _('Supported formats: .csv, .xls, .xlsx') }}
                            </span>
                        </div>
                    </div>
                    <div id="selectedFileName" class="mt-2 text-center hidden"
                        style="color: var(--wizard-primary); font-weight: 600; margin-top: 10px;"></div>
                </div>
            </div>

            <div class="wizard-footer">
                <button class="btn-wizard-back" onclick="goToStep(1)">{{ _('Cancel') }}</button>
                <button class="btn-wizard-next" id="nextStep2Btn" onclick="uploadAndProceed()" disabled>
                    {{ _('Continue to Mapping') }} <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- STEP 3: MAPPING -->
        <div id="step3" class="wizard-panel hidden">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                <div>
                    <h2 class="wizard-title-lg" style="font-size: 1.5rem;">{{ _('Map CSV Columns') }}</h2>
                    <p class="wizard-subtitle" style="margin-bottom: 0;">{{ _('Match your file columns to SunnRayy\'s
                        data structure.') }}</p>
                </div>
                <!-- Magic Map Button -->
                <button class="btn-magic-map">
                    <i class="fas fa-magic"></i> {{ _('Magic Map') }}
                </button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                <!-- Left: Preview Table -->
                <div style="min-width: 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: 600; font-size: 0.875rem; color: var(--wizard-text-sub);">
                            <i class="fas fa-table me-1"></i> {{ _('CSV Preview') }}
                        </span>
                        <span
                            style="font-family: monospace; font-size: 0.75rem; background: var(--bg-container-inset); padding: 2px 6px; border-radius: 4px;">
                            export_2023.csv
                        </span>
                    </div>
                    <div
                        style="overflow-x: auto; border: 1px solid var(--wizard-border); border-radius: var(--radius-lg);">
                        <table class="table-validation" id="previewTable">
                            <!-- Populated by JS -->
                        </table>
                    </div>
                </div>

                <!-- Right: Configuration Form -->
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: 600; font-size: 0.875rem; color: var(--wizard-text-sub);">
                            <i class="fas fa-sliders-h me-1"></i> {{ _('Configuration') }}
                        </span>
                    </div>
                    <div id="columnMappingForm"
                        style="display: flex; flex-direction: column; gap: 16px; background: var(--bg-container-inset); padding: 20px; border-radius: var(--radius-lg);">
                        <!-- Fields injected by JS -->
                    </div>
                </div>
            </div>

            <div class="wizard-footer">
                <button class="btn-wizard-back" onclick="goToStep(2)">{{ _('Back') }}</button>
                <button class="btn-wizard-next" onclick="configureAndValidate()">
                    {{ _('Next Step') }} <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- STEP 4: REVIEW & VALIDATE -->
        <div id="step4" class="wizard-panel hidden">
            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
                <div class="space-y-1">
                    <h2 class="wizard-title-lg"
                        style="font-size: 1.875rem; letter-spacing: -0.025em; display: flex; align-items: center; gap: 1rem;">
                        {{ _('Review & Fix Errors') }}
                        <span id="errorPill"
                            class="px-3 py-0.5 rounded-full text-xs font-bold border transition-colors hidden"
                            style="font-size: 0.75rem; border-width: 1px;">
                            <!-- Content set by JS -->
                        </span>
                    </h2>
                    <p class="wizard-subtitle" style="margin-bottom: 0;">{{ _('Please review the parsed data. AI has
                        identified issues.') }}</p>
                </div>
                <div class="flex gap-3">
                    <!-- Placeholder for Magic Fix button if implemented later -->
                </div>
            </div>

            <div
                style="background: var(--bg-container); border: 1px solid var(--wizard-border); border-radius: var(--radius-lg); overflow: hidden;">
                <!-- Toolbar -->
                <div
                    style="padding: 16px 24px; border-bottom: 1px solid var(--wizard-border); background: white; display: flex; items-center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="relative" style="position: relative;">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
                            <input type="text" placeholder="Filter transactions..." class="form-input"
                                style="padding-left: 2.5rem; padding-right: 1rem; py: 0.5rem; border-radius: 0.75rem; width: 18rem; border: 1px solid #e2e8f0;">
                        </div>
                        <div style="height: 1.5rem; width: 1px; background: #e2e8f0;"></div>
                        <button class="btn btn-sm text-slate-500 font-bold hover:bg-slate-50"
                            style="color: #64748b; background: transparent; border: none; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-filter"></i> {{ _('All Status') }}
                        </button>
                    </div>
                    <div class="text-xs text-muted d-flex align-items-center"
                        style="font-size: 0.8125rem; color: #94a3b8; gap: 0.5rem;">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        AI suggestions are marked with <span class="text-indigo-600 font-bold"
                            style="color: #4f46e5;">Sparkles</span>
                    </div>
                </div>

                <!-- Validation Table Container -->
                <div style="max-height: 400px; overflow-y: auto;" id="validationTableContainer">
                    <div id="errorList" class="hidden p-3"
                        style="background: var(--wizard-error-bg); color: var(--wizard-error); padding: 10px; font-size: 0.875rem;">
                    </div>
                    <!-- Reuse preview table structure for now, ideally strictly typed rows -->
                </div>

                <!-- Summary Footer -->
                <div
                    style="padding: 12px 16px; border-top: 1px solid var(--wizard-border); background: var(--bg-container-inset); display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 20px; font-size: 0.875rem;">
                        <span style="color: var(--wizard-success); font-weight: 600;"><i class="fas fa-circle"
                                style="font-size: 8px;"></i> <span id="validRowCount">0</span> {{ _('rows ready')
                            }}</span>
                        <span style="color: var(--wizard-error); font-weight: 600;"><i class="fas fa-circle"
                                style="font-size: 8px;"></i> <span id="errorRowCount">0</span> {{ _('rows need
                            attention') }}</span>
                    </div>
                    <div>
                        <button class="btn-wizard-next" onclick="publishData()">
                            <span id="importBtnText">{{ _('Import Transactions') }}</span> <i
                                class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="wizard-footer border-0 pt-0 mt-4">
                <button class="btn-wizard-back" onclick="goToStep(3)">{{ _('Back') }}</button>
            </div>
        </div>

        <!-- STEP 5: DONE -->
        <div id="step5" class="wizard-panel hidden" style="background: transparent; border: none; padding: 0;">
            <!-- Uploading State -->
            <div id="uploadingState" class="flex flex-col items-center justify-center space-y-8 py-20 hidden">
                <div class="relative">
                    <div class="w-24 h-24 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="fas fa-cloud-upload-alt text-blue-600 animate-pulse text-2xl"></span>
                    </div>
                </div>
                <div class="text-center space-y-2">
                    <h2 class="text-2xl font-bold text-slate-900">Finalizing Import...</h2>
                    <p class="text-slate-500">Committing records to your portfolio database.</p>
                </div>
            </div>

            <!-- Success State -->
            <div id="successState" class="hidden max-w-2xl mx-auto space-y-10 py-10 animate-[fadeIn_0.5s_ease-out]">
                <div
                    class="bg-white border border-slate-200 rounded-3xl shadow-2xl shadow-slate-200/50 overflow-hidden">
                    <div class="bg-emerald-500 p-10 flex flex-col items-center text-white relative overflow-hidden">
                        <!-- Decorative background shapes -->
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                        <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-black/10 rounded-full blur-2xl"></div>

                        <div
                            class="w-20 h-20 bg-white rounded-full flex items-center justify-center text-emerald-500 mb-6 shadow-xl animate-[bounce_1s_infinite_alternate]">
                            <span class="fas fa-check-circle text-4xl"></span>
                        </div>
                        <h1 class="text-3xl font-extrabold mb-2">Import Successful!</h1>
                        <p class="text-emerald-50 text-center opacity-90 max-w-sm">
                            Your data has been processed and is now available across the WealthOS platform.
                        </p>
                    </div>

                    <div class="p-10 space-y-8">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total
                                    Imported</p>
                                <p class="text-2xl font-black text-slate-900"><span id="finalRowCount">0</span> <span
                                        class="text-sm font-medium text-slate-500">Rows</span></p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Import ID
                                </p>
                                <p class="text-xl font-bold text-slate-700 font-mono" id="finalImportId">#---</p>
                            </div>
                        </div>

                        <div class="flex flex-col gap-3 pt-4">
                            <a href="{{ url_for('data_workbench.index') }}"
                                class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl hover:bg-slate-800 transition-all shadow-xl shadow-slate-200 flex items-center justify-center gap-2 group text-decoration-none">
                                Go to Data Workbench
                                <span class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></span>
                            </a>
                            <a href="{{ url_for('reports.portfolio') }}"
                                class="w-full py-4 bg-white border border-slate-200 text-slate-600 font-bold rounded-2xl hover:bg-slate-50 transition-all flex items-center justify-center gap-2 text-decoration-none">
                                <span class="fas fa-chart-pie text-xl"></span>
                                View in Portfolio
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Wizard State
    let wizardState = {
        importId: null,
        importType: null,
        step: 1,
        headers: [],
        preview: [],
        detectedMapping: {},
        validRows: 0,
        errorRows: 0,
        errors: []
    };

    // HISTORY FUNCTIONALITY
    function toggleHistory() {
        const panel = document.getElementById('historyPanel');
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            loadImportHistory();
        } else {
            panel.classList.add('hidden');
        }
    }

    function loadImportHistory() {
        fetch('/workbench/api/import-history')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('historyTableBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px; color: var(--text-tertiary);">No import history</td></tr>';
                    return;
                }

                data.forEach(record => {
                    const tr = document.createElement('tr');

                    const uploadDate = record.uploaded_at ? new Date(record.uploaded_at).toLocaleDateString() : '-';

                    let statusClass = 'text-gray-600';
                    if (record.status === 'promoted') statusClass = 'text-success font-weight-bold';
                    else if (record.status === 'error') statusClass = 'text-danger';

                    tr.innerHTML = `
                        <td style="font-family: monospace;">${(record.batch_id || '').substring(0, 8)}...</td>
                        <td class="${statusClass}">${record.status}</td>
                        <td style="color: var(--text-tertiary);">${uploadDate}</td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(error => console.error('Error loading import history:', error));
    }

    // Step Navigation
    function goToStep(step) {
        if (step === 1) {
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('wizard-flow').classList.add('hidden');
        } else {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('wizard-flow').classList.remove('hidden');

            document.querySelectorAll('.wizard-panel').forEach(el => {
                if (el.id !== 'step1') el.classList.add('hidden');
            });
            document.getElementById('step' + step).classList.remove('hidden');

            updateProgressBar(step);
        }

        wizardState.step = step;
        document.getElementById('currentStep').value = step;
        window.scrollTo(0, 0);
    }

    function updateProgressBar(currentStep) {
        let pct = 0;
        if (currentStep >= 2) pct = 25;
        if (currentStep >= 3) pct = 50;
        if (currentStep >= 4) pct = 75;
        if (currentStep >= 5) pct = 100;

        document.getElementById('progressLineActive').style.width = String(pct) + '%';

        for (let i = 2; i <= 5; i++) {
            const stepEl = document.getElementById('progress-step-' + i);
            if (!stepEl) continue;

            stepEl.classList.remove('active', 'completed');

            if (i < currentStep) {
                stepEl.classList.add('completed');
                stepEl.querySelector('.step-circle').innerHTML = '<i class="fas fa-check"></i>';
            } else if (i === currentStep) {
                stepEl.classList.add('active');
                stepEl.querySelector('.step-circle').innerHTML = i;
            } else {
                stepEl.querySelector('.step-circle').innerHTML = i;
            }
        }
    }

    // --- Backend Integration Logic (Reused) ---

    async function selectImportType(type, cardEl) {
        document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));

        wizardState.importType = type;

        // Show loading spinner on card if feasible, or just modal
        // const originalContent = cardEl.innerHTML;

        try {
            const response = await fetch('/workbench/api/imports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type })
            });

            if (!response.ok) throw new Error('Failed to create import session');

            const data = await response.json();
            wizardState.importId = data.import_id;
            document.getElementById('importSessionId').value = data.import_id;

            goToStep(2);
        } catch (error) {
            console.error(error);
            alert('Error creating session');
        }
    }

    function resumePendingImport() {
        alert("Resume logic would go here - not implemented in demo.");
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const display = document.getElementById('selectedFileName');
            display.textContent = 'Selected: ' + file.name;
            display.classList.remove('hidden');
            document.getElementById('nextStep2Btn').disabled = false;
        }
    }

    function switchUploadMode(mode) {
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Drag & Drop
    const dropzone = document.getElementById('dropzone');
    if (dropzone) {
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = 'var(--wizard-primary)';
            dropzone.style.background = '#EFF6FF';
        });
        dropzone.addEventListener('dragleave', () => {
            dropzone.style.borderColor = 'var(--brand-blue-light)'; // Reset
            dropzone.style.background = 'linear-gradient(180deg, var(--wizard-primary-light) 0%, rgba(255,255,255,0) 100%)';
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('wizardFileInput').files = files;
                handleFileSelect({ target: { files: files } });
            }
        });
    }

    async function uploadAndProceed() {
        const fileInput = document.getElementById('wizardFileInput');
        const file = fileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        const separator = document.getElementById('columnSeparator').value;
        const impId = document.getElementById('importSessionId').value;

        const btn = document.getElementById('nextStep2Btn');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        btn.disabled = true;

        try {
            const response = await fetch(`/workbench/api/imports/${impId}/upload?separator=${encodeURIComponent(separator)}`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Upload failed');

            const data = await response.json();
            wizardState.headers = data.headers;
            wizardState.preview = data.preview;
            wizardState.detectedMapping = data.detected_mapping || {};

            renderMappingForm();
            renderPreviewTable(data.preview, data.headers); // Helper
            goToStep(3);
        } catch (error) {
            console.error(error);
            alert('Upload failed: ' + error.message);
        } finally {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    }

    function renderMappingForm() {
        const container = document.getElementById('columnMappingForm');
        container.innerHTML = '';

        const fields = [
            { id: 'date', label: 'Date', required: true, icon: 'fa-calendar' },
            { id: 'amount', label: 'Amount', required: true, icon: 'fa-dollar-sign' },
            { id: 'description', label: 'Description', required: true, icon: 'fa-file-alt' },
            { id: 'symbol', label: 'Ticker / Symbol', required: false, icon: 'fa-chart-line' }
        ];

        fields.forEach(f => {
            const div = document.createElement('div');
            const detected = wizardState.detectedMapping[f.id] || '';
            const isAuto = detected !== '';

            div.innerHTML = `
                <div style="background: white; padding: 12px; border: 1px solid var(--wizard-border); border-radius: var(--radius-md); margin-bottom: 8px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 4px;">
                        <label style="font-size: 0.875rem; font-weight: 600; color: var(--wizard-text-main);">
                            <i class="fas ${f.icon} text-muted me-1"></i> ${f.label} ${f.required ? '<span class="text-danger">*</span>' : ''}
                        </label>
                        ${isAuto ? '<span class="text-success" style="font-size: 0.7rem; font-weight: 700; background: var(--wizard-success-bg); padding: 1px 6px; border-radius: 4px;">AUTO</span>' : ''}
                    </div>
                    <select id="map_${f.id}" class="form-select w-100" style="font-size: 0.875rem; width: 100%; padding: 8px; border: 1px solid var(--wizard-border); border-radius: var(--radius-md);">
                        <option value="">-- Select Column --</option>
                        ${wizardState.headers.map(h => `<option value="${h}" ${h === detected ? 'selected' : ''}>${h}</option>`).join('')}
                    </select>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function renderPreviewTable(rows, headers) {
        const table = document.getElementById('previewTable');
        if (!rows || rows.length === 0) return;

        let html = '<thead><tr>';
        headers.forEach(h => html += `<th>${h}</th>`);
        html += '</tr></thead><tbody>';

        rows.slice(0, 5).forEach(row => {
            html += '<tr>';
            headers.forEach(h => html += `<td>${row[h] || ''}</td>`);
            html += '</tr>';
        });
        html += '</tbody>';
        table.innerHTML = html;
    }

    function configureAndValidate() {
        const mapping = {};
        let missing = false;
        ['date', 'amount', 'description'].forEach(f => {
            const el = document.getElementById('map_' + f);
            if (el && !el.value) missing = true;
            if (el) mapping[f] = el.value;
        });

        if (missing) {
            alert('Please map all required fields.');
            return;
        }

        const impId = document.getElementById('importSessionId').value;

        fetch(`/workbench/api/imports/${impId}/configure`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mapping: mapping })
        })
            .then(() => fetch(`/workbench/api/imports/${impId}/validate`, { method: 'POST' }))
            .then(res => res.json())
            .then(data => {
                wizardState.validRows = data.valid_count;
                wizardState.errorRows = data.error_count;
                wizardState.errors = data.errors || [];

                document.getElementById('validRowCount').textContent = wizardState.validRows;
                document.getElementById('errorRowCount').textContent = wizardState.errorRows;

                // Update Error Pill
                const pill = document.getElementById('errorPill');
                pill.classList.remove('hidden');
                if (wizardState.errorRows > 0) {
                    pill.className = "px-3 py-0.5 rounded-full text-xs font-bold border transition-colors bg-red-100 text-red-700 border-red-200";
                    pill.textContent = `${wizardState.errorRows} Errors Remaining`;
                    document.getElementById('errorList').classList.remove('hidden');
                    document.getElementById('errorList').innerHTML = wizardState.errors.slice(0, 5).map(e => `<div>â€¢ Row ${e.row}: ${e.errors.map(x => x.message).join(', ')}</div>`).join('') + (wizardState.errors.length > 5 ? `<div>...and ${wizardState.errors.length - 5} more.</div>` : '');
                } else {
                    pill.className = "px-3 py-0.5 rounded-full text-xs font-bold border transition-colors bg-emerald-100 text-emerald-700 border-emerald-200";
                    pill.textContent = "All Errors Fixed!";
                    document.getElementById('errorList').classList.add('hidden');
                }

                renderValidationTable(data.preview_rows);

                document.getElementById('importBtnText').textContent = `Import ${wizardState.validRows} Rows`;
                goToStep(4);
            })
            .catch(err => alert('Validation failed'));
    }

    function renderValidationTable(rows) {
        const container = document.getElementById('validationTableContainer');
        if (!container) return; // Should exist if HTML updated

        if (!rows || rows.length === 0) {
            container.innerHTML = '<div class="p-4 text-center text-muted">No rows to display</div>';
            return;
        }

        let html = `
        <table class="w-100 text-left" style="border-collapse: collapse; min-width: 100%;">
            <thead class="bg-slate-50 border-b border-slate-200" style="position: sticky; top: 0; z-index: 10; background: #f8fafc;">
                <tr style="font-size: 0.625rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">
                    <th class="py-4 px-6 border-r border-slate-200 text-center" style="width: 3rem;">#</th>
                    <th class="py-4 px-6 border-r border-slate-200">Date</th>
                    <th class="py-4 px-6 border-r border-slate-200">Asset</th>
                    <th class="py-4 px-6 border-r border-slate-200">Type</th>
                    <th class="py-4 px-6 border-r border-slate-200 text-right">Amount</th>
                    <th class="py-4 px-6">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 text-sm">
        `;

        rows.forEach(row => {
            const isError = !row.valid;
            const rowId = row.index;

            // Row styling
            let trClass = "transition-colors hover:bg-slate-50";
            let trStyle = "border-bottom: 1px solid #f1f5f9; padding: 0.75rem 1.5rem;";
            if (isError) {
                trStyle += " background-color: rgba(254, 242, 242, 0.4); border-left: 4px solid #ef4444;";
            }

            // Cell Renderers
            const statusCell = !isError
                ? `<span class="flex items-center gap-1.5 text-emerald-600 font-bold text-xs uppercase tracking-widest" style="color: #059669; display: flex; align-items: center; gap: 0.375rem;">
                     <i class="fas fa-check-circle" style="font-size: 1rem;"></i> Ready
                   </span>`
                : `<div class="flex flex-col">
                     <span class="text-red-600 font-extrabold text-[10px] uppercase tracking-widest" style="color: #dc2626; font-size: 0.625rem;">Error</span>
                     <span class="text-red-400 italic error-cell" style="font-size: 0.625rem; color: #f87171;">${row.errors.join(', ')}</span>
                   </div>`;

            const dateStyle = isError && row.errors.some(e => e.toLowerCase().includes('date')) ? 'color: #dc2626; font-weight: 700;' : 'color: #64748b; font-family: monospace;';
            const assetStyle = isError && row.errors.some(e => e.toLowerCase().includes('asset')) ? 'color: #dc2626; font-weight: 700;' : 'font-weight: 700; color: #0f172a;';

            html += `<tr class="${trClass}" id="row-${rowId}" style="${trStyle}">
                <td class="py-3 px-6 text-center border-r border-slate-100" style="padding: 0.75rem 1.5rem; border-right: 1px solid #f1f5f9;">${rowId}</td>
                
                <td contenteditable="true" onblur="updateCell(${rowId}, 'date', this.innerText)" 
                    class="py-3 px-6 font-mono border-r border-slate-100" 
                    style="padding: 0.75rem 1.5rem; border-right: 1px solid #f1f5f9; ${dateStyle}">
                    ${row.data.date || ''}
                </td>
                
                <td contenteditable="true" onblur="updateCell(${rowId}, 'asset_id', this.innerText)" 
                    class="py-3 px-6 border-r border-slate-100" 
                    style="padding: 0.75rem 1.5rem; border-right: 1px solid #f1f5f9; ${assetStyle}">
                    ${row.data.asset_id || ''}
                </td>
                
                <td contenteditable="true" onblur="updateCell(${rowId}, 'transaction_type', this.innerText)" 
                    class="py-3 px-6 border-r border-slate-100" 
                    style="padding: 0.75rem 1.5rem; border-right: 1px solid #f1f5f9;">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-[11px] font-bold uppercase tracking-wider bg-blue-50 text-blue-600" style="background: #eff6ff; color: #2563eb; border-radius: 0.25rem; font-size: 0.6875rem;">
                        ${row.data.transaction_type || ''}
                    </span>
                </td>
                
                <td contenteditable="true" onblur="updateCell(${rowId}, 'amount', this.innerText)" 
                    class="py-3 px-6 font-mono text-right border-r border-slate-100" 
                    style="padding: 0.75rem 1.5rem; border-right: 1px solid #f1f5f9; font-family: monospace; text-align: right; color: #0f172a;">
                    ${row.data.amount || ''}
                </td>
                
                <td class="py-3 px-6" style="padding: 0.75rem 1.5rem;">
                    ${statusCell}
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function updateCell(rowIndex, field, value) {
        const impId = document.getElementById('importSessionId').value;
        try {
            const res = await fetch(`/workbench/api/imports/${impId}/update-row`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ row_index: rowIndex, field: field, value: value.trim() })
            });
            const data = await res.json();

            if (data.success) {
                // Update row status visual
                const rowEl = document.getElementById(`row-${rowIndex}`);
                const isError = data.new_errors && data.new_errors.length > 0;

                // Update styles directly
                if (isError) {
                    rowEl.style.backgroundColor = 'rgba(254, 242, 242, 0.4)';
                    rowEl.style.borderLeft = '4px solid #ef4444';
                    rowEl.cells[5].innerHTML = `<div class="flex flex-col">
                     <span class="text-red-600 font-extrabold text-[10px] uppercase tracking-widest" style="color: #dc2626; font-size: 0.625rem;">Error</span>
                     <span class="text-red-400 italic error-cell" style="font-size: 0.625rem; color: #f87171;">${data.new_errors.join(', ')}</span>
                   </div>`;
                } else {
                    rowEl.style.backgroundColor = '';
                    rowEl.style.borderLeft = ''; // Reset
                    rowEl.cells[5].innerHTML = `<span class="flex items-center gap-1.5 text-emerald-600 font-bold text-xs uppercase tracking-widest" style="color: #059669; display: flex; align-items: center; gap: 0.375rem;">
                     <i class="fas fa-check-circle" style="font-size: 1rem;"></i> Ready
                   </span>`;
                }
            } else {
                alert('Update failed: ' + data.error);
            }
        } catch (err) {
            console.error(err);
        }
    }

    function publishData() {
        // Show Step 5 container
        goToStep(5);

        // Show uploading state, hide success state
        document.getElementById('uploadingState').classList.remove('hidden');
        document.getElementById('successState').classList.add('hidden');

        const impId = document.getElementById('importSessionId').value;

        // Artificial delay if needed to show the spinner (optional, but good for UX feel)
        setTimeout(() => {
            fetch(`/workbench/api/imports/${impId}/publish`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    // Slight delay to ensure spinner is seen if API is instant
                    setTimeout(() => {
                        document.getElementById('uploadingState').classList.add('hidden');
                        document.getElementById('successState').classList.remove('hidden');

                        // Populate stats
                        document.getElementById('finalRowCount').textContent = wizardState.validRows;
                        document.getElementById('finalImportId').textContent = "WOS-" + (wizardState.importId ? wizardState.importId.substring(0, 8).toUpperCase() : '---');
                    }, 800);
                })
                .catch(err => {
                    alert('Publish failed');
                    goToStep(4); // Go back on error
                });
        }, 500);
    }
</script>
{% endblock %}