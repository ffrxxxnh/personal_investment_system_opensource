{% extends "base.html" %}

{% block title %}Portfolio & Performance Report{% endblock %}

{% block content %}
<div class="space-y-8 pb-12">
    <!-- Net Worth Hero Section -->
    <div class="bg-white rounded-4xl border border-slate-200 shadow-sm p-8 md:p-10 relative overflow-hidden">
        <!-- Gradient top border -->
        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-brand-gold to-brand-blue"></div>

        <div class="relative z-10">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">{{ _('Net Worth') }}</p>
            <div class="flex items-end gap-4 mb-4">
                <h1 class="text-5xl md:text-6xl font-extrabold text-slate-900 tracking-tight">¥{{ total_net_assets }}
                </h1>
                <span class="text-lg font-bold mb-2
                    {% if dual_metrics.trailing_12m.portfolio_growth != 'N/A' and dual_metrics.trailing_12m.portfolio_growth | float > 0 %}
                        text-emerald-500
                    {% else %}
                        text-rose-500
                    {% endif %}">
                    <i class="fa-solid 
                        {% if dual_metrics.trailing_12m.portfolio_growth != 'N/A' and dual_metrics.trailing_12m.portfolio_growth | float > 0 %}
                            fa-arrow-trend-up
                        {% else %}
                            fa-arrow-trend-down
                        {% endif %} mr-1"></i>
                    {{ dual_metrics.trailing_12m.portfolio_growth }}%
                    <span class="text-slate-400 font-medium ml-1">{{ _('trailing 12 months') }}</span>
                </span>
            </div>
        </div>

        <!-- Embedded Growth Chart -->
        <div class="h-80 w-full mt-6">
            <canvas id="portfolioGrowthChart"></canvas>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- 12-Month Return -->
        <div
            class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 border-l-4 border-l-brand-gold hover:shadow-md transition-shadow">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">{{ _('12-Month Return') }}
            </p>
            <p class="text-3xl font-extrabold tracking-tight
                {% if dual_metrics.trailing_12m.portfolio_growth != 'N/A' and dual_metrics.trailing_12m.portfolio_growth | float > 0 %}
                    text-emerald-500
                {% else %}
                    text-rose-500
                {% endif %}">
                {{ dual_metrics.trailing_12m.portfolio_growth }}%
            </p>
        </div>

        <!-- Holdings -->
        <div
            class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 border-l-4 border-l-brand-blue hover:shadow-md transition-shadow">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">{{ _('Holdings') }}</p>
            <p class="text-3xl font-extrabold text-slate-900 tracking-tight">{{ holdings|length }}</p>
        </div>

        <!-- Liquid Assets -->
        <div
            class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 border-l-4 border-l-emerald-500 hover:shadow-md transition-shadow">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">{{ _('Liquid Assets') }}</p>
            <p class="text-3xl font-extrabold text-slate-900 tracking-tight">¥{{ total_liquid_portfolio }}</p>
        </div>

        <!-- Lifetime XIRR -->
        <div
            class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 border-l-4 border-l-indigo-500 hover:shadow-md transition-shadow">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">{{ _('Lifetime XIRR') }}</p>
            <p class="text-3xl font-extrabold text-brand-blue tracking-tight">{{ dual_metrics.lifetime.xirr }}%</p>
        </div>
    </div>

    <!-- Trailing 12-Month Performance -->
    <div>
        <h4 class="flex items-center gap-2 text-lg font-bold text-slate-900 mb-6">
            <i class="fa-regular fa-calendar-days text-brand-blue"></i>
            {{ _('Trailing 12-Month Performance') }}
        </h4>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- 12-Month XIRR -->
            <div
                class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 text-center hover:shadow-md transition-shadow">
                <p class="text-3xl font-extrabold text-slate-700 mb-2">
                    {{ dual_metrics.trailing_12m.xirr }}{% if dual_metrics.trailing_12m.xirr != "N/A" %}%{% endif %}
                </p>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ _('12-Month XIRR') }}</p>
                <p class="text-xs text-slate-400 mt-1">{{ _('Excl. Real Estate') }}</p>
            </div>

            <!-- 12-Month Growth -->
            <div
                class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 text-center hover:shadow-md transition-shadow">
                <p class="text-3xl font-extrabold text-slate-700 mb-2">
                    {{ dual_metrics.trailing_12m.portfolio_growth }}{% if dual_metrics.trailing_12m.portfolio_growth !=
                    "N/A" %}%{% endif %}
                </p>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ _('12-Month Growth') }}</p>
            </div>

            <!-- 12-Month TWR -->
            <div
                class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 text-center hover:shadow-md transition-shadow">
                <p class="text-3xl font-extrabold text-slate-700 mb-2">
                    {{ dual_metrics.trailing_12m.twr }}{% if dual_metrics.trailing_12m.twr != "N/A" %}%{% endif %}
                </p>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ _('12-Month TWR') }}</p>
            </div>

            <!-- 12-Month Sharpe -->
            <div
                class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 text-center hover:shadow-md transition-shadow">
                <p class="text-3xl font-extrabold text-slate-700 mb-2">{{ dual_metrics.trailing_12m.sharpe }}</p>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ _('12-Month Sharpe') }}</p>
            </div>
        </div>
    </div>

    <!-- Current Asset Allocation -->
    <div>
        <h4 class="flex items-center gap-2 text-lg font-bold text-slate-900 mb-6">
            <i class="fa-solid fa-chart-pie text-brand-blue"></i>
            {{ _('Detailed Allocation') }}
        </h4>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8">
                <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest text-center mb-6">Major Asset
                    Classes</h5>
                <div class="h-[350px] relative">
                    <canvas id="topLevelChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8">
                <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest text-center mb-6">Sub-Class
                    Breakdown</h5>
                <div class="h-[350px] relative">
                    <canvas id="subClassChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance by Asset Class -->
    <div>
        <h4 class="flex items-center gap-2 text-lg font-bold text-slate-900 mb-6">
            <i class="fa-solid fa-chart-bar text-brand-blue"></i>
            {{ _('Performance by Asset Class') }}
        </h4>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8">
                <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest text-center mb-6">Top-Level
                    Performance (XIRR)</h5>
                <div class="h-[400px] relative">
                    <canvas id="topLevelPerfChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8">
                <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest text-center mb-6">Sub-Class
                    Performance (XIRR)</h5>
                <div class="h-[400px] relative">
                    <canvas id="subClassPerfChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Performance Charts -->
    <div>
        <h4 class="flex items-center gap-2 text-lg font-bold text-slate-900 mb-6">
            <i class="fa-solid fa-chart-line text-brand-blue"></i>
            {{ _('Historical Performance') }}
        </h4>

        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8">
            <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest text-center mb-2">Monthly Cash Flow
                Analysis</h5>
            <p class="text-sm text-slate-500 mb-6 text-center">Income, expenses, and investments breakdown over time</p>
            <div class="h-[400px] relative">
                <canvas id="cashFlowChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Realized vs. Unrealized Gains Analysis -->
    {% if gains_analysis_data is defined and gains_analysis_data %}
    <div>
        <h4 class="flex items-center gap-2 text-lg font-bold text-slate-900 mb-6">
            <i class="fa-solid fa-coins text-brand-blue"></i>
            {{ _('Realized vs. Unrealized Gains Analysis') }}
        </h4>

        <!-- KPI Cards Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div
                class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 border-l-4 border-l-emerald-500 hover:shadow-md transition-shadow">
                <p class="text-3xl font-extrabold text-emerald-500 tracking-tight mb-2">¥{{
                    "{:,.0f}".format(gains_analysis_data.realized_gains) }}</p>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ _('Total Realized Gains')
                    }}</p>
                <p class="text-xs text-slate-400 mt-1">Profits locked in from sales</p>
            </div>
            <div
                class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 border-l-4 border-l-brand-blue hover:shadow-md transition-shadow">
                <p class="text-3xl font-extrabold text-brand-blue tracking-tight mb-2">¥{{
                    "{:,.0f}".format(gains_analysis_data.unrealized_gains) }}</p>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ _('Total Unrealized Gains')
                    }}</p>
                <p class="text-xs text-slate-400 mt-1">Paper gains from current holdings</p>
            </div>
            <div
                class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 border-l-4 border-l-violet-500 hover:shadow-md transition-shadow">
                <p class="text-3xl font-extrabold text-violet-600 tracking-tight mb-2">¥{{
                    "{:,.0f}".format(gains_analysis_data.total_gains) }}</p>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ _('Total Gains') }}</p>
                <p class="text-xs text-slate-400 mt-1">Realized + Unrealized</p>
            </div>
        </div>

        <!-- Sub-Class Breakdown Table -->
        {% if gains_analysis_data.subclass_breakdown %}
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 overflow-hidden">
            <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Sub-Class Level Breakdown</h5>
            <p class="text-sm text-slate-500 mb-6">Detailed gains analysis by asset sub-class</p>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr
                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">
                            <th class="px-4 py-3">{{ _('Sub-Class') }}</th>
                            <th class="px-4 py-3 text-right">{{ _('Realized Gains') }}</th>
                            <th class="px-4 py-3 text-right">{{ _('Unrealized Gains') }}</th>
                            <th class="px-4 py-3 text-right">{{ _('Total Gains') }}</th>
                            <th class="px-4 py-3 text-right">{{ _('Realization') }} %</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 text-sm">
                        {% for sub_class, data in gains_analysis_data.subclass_breakdown.items() %}
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-4 py-3 font-semibold text-slate-900">{{ sub_class }}</td>
                            <td class="px-4 py-3 text-right text-emerald-500 font-medium">¥{{
                                "{:,.0f}".format(data.realized_gains) }}</td>
                            <td class="px-4 py-3 text-right text-brand-blue font-medium">¥{{
                                "{:,.0f}".format(data.unrealized_gains) }}</td>
                            <td class="px-4 py-3 text-right font-bold text-slate-900">¥{{
                                "{:,.0f}".format(data.total_gains) }}</td>
                            <td class="px-4 py-3 text-right text-slate-500">
                                {% if data.total_gains != 0 %}
                                {{ "{:.1f}".format((data.realized_gains / data.total_gains * 100) if data.total_gains !=
                                0 else 0) }}%
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Parse allocation data for charts
    const topLevelData = JSON.parse('{{ top_level_allocation_json | safe }}');
    const subClassData = JSON.parse('{{ sub_class_allocation_json | safe }}');

    // SunnRayy Color Palette - Modern & Professional
    const bgColors = [
        '#D4AF37', // Gold (Equity)
        '#0f172a', // Dark Navy (Fixed Income)
        '#64748b', // Slate Gray (Cash)
        '#0ea5e9', // Sky Blue (Alts)
        '#b45309', // Dark Amber (Real Estate)
        '#14b8a6', // Teal (Crypto)
        '#6366f1', // Indigo (Commodities)
        '#78716c', // Stone (Other)
        '#f59e0b', // Amber
        '#ec4899'  // Pink
    ];

    // Chart.js Global Defaults
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#64748b';
    Chart.defaults.scale.grid.color = '#f1f5f9';

    // Initialize Top Level Chart
    const ctxTop = document.getElementById('topLevelChart').getContext('2d');
    new Chart(ctxTop, {
        type: 'doughnut',
        data: {
            labels: topLevelData.labels,
            datasets: [{
                data: topLevelData.values,
                backgroundColor: bgColors,
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'right',
                    labels: { usePointStyle: true, boxWidth: 8, padding: 20, font: { size: 12 } }
                },
                title: { display: false }
            }
        }
    });

    // Initialize Sub Class Chart
    const ctxSub = document.getElementById('subClassChart').getContext('2d');
    new Chart(ctxSub, {
        type: 'doughnut',
        data: {
            labels: subClassData.labels,
            datasets: [{
                data: subClassData.values,
                backgroundColor: bgColors,
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'right',
                    labels: { usePointStyle: true, boxWidth: 8, padding: 20, font: { size: 12 } }
                },
                title: { display: false }
            }
        }
    });

    // Parse performance data for charts
    const topLevelPerfData = JSON.parse('{{ top_level_performance_json | safe }}');
    const subClassPerfData = JSON.parse('{{ sub_class_performance_json | safe }}');

    // Initialize Top Level Performance Chart
    const ctxTopPerf = document.getElementById('topLevelPerfChart').getContext('2d');
    new Chart(ctxTopPerf, {
        type: 'bar',
        data: {
            labels: topLevelPerfData.labels,
            datasets: [{
                label: '{{ _("XIRR") }} (%)',
                data: topLevelPerfData.values,
                backgroundColor: bgColors,
                borderRadius: 4,
                barPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { borderDash: [2, 2] },
                    ticks: {
                        callback: function (value) { return value + '%'; }
                    }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // Initialize Sub Class Performance Chart
    const ctxSubPerf = document.getElementById('subClassPerfChart').getContext('2d');
    new Chart(ctxSubPerf, {
        type: 'bar',
        data: {
            labels: subClassPerfData.labels,
            datasets: [{
                label: '{{ _("XIRR") }} (%)',
                data: subClassPerfData.values,
                backgroundColor: bgColors,
                borderRadius: 4,
                barPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { borderDash: [2, 2] },
                    ticks: {
                        callback: function (value) { return value + '%'; }
                    }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // Initialize Portfolio Growth Chart
    const portfolioGrowthData = JSON.parse('{{ portfolio_growth_json | safe }}');
    if (portfolioGrowthData && portfolioGrowthData.dates && portfolioGrowthData.dates.length > 0) {
        const ctxGrowth = document.getElementById('portfolioGrowthChart').getContext('2d');
        new Chart(ctxGrowth, {
            type: 'line',
            data: {
                labels: portfolioGrowthData.dates,
                datasets: [{
                    label: '{{ _("Portfolio Growth") }} (%)',
                    data: portfolioGrowthData.growth_values,
                    borderColor: '#10b981', // Emerald Primary
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#1e293b',
                        bodyColor: '#475569',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function (context) {
                                return context.parsed.y.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: false,
                        grid: { borderDash: [4, 4], color: '#f1f5f9' },
                        ticks: {
                            callback: function (value) { return value + '%'; }
                        }
                    }
                }
            }
        });
    }

    // Initialize Cash Flow Chart
    const cashFlowData = JSON.parse('{{ cash_flow_json | safe }}');
    if (cashFlowData && cashFlowData.dates && cashFlowData.dates.length > 0) {
        const ctxCashFlow = document.getElementById('cashFlowChart').getContext('2d');
        new Chart(ctxCashFlow, {
            type: 'bar',
            data: {
                labels: cashFlowData.dates,
                datasets: [
                    {
                        label: '{{ _("Income") }}',
                        data: cashFlowData.income,
                        backgroundColor: '#10b981', // Emerald
                        borderRadius: 4,
                        barPercentage: 0.7
                    },
                    {
                        label: '{{ _("Expenses") }}',
                        data: cashFlowData.expenses,
                        backgroundColor: '#f43f5e', // Rose
                        borderRadius: 4,
                        barPercentage: 0.7
                    },
                    {
                        label: '{{ _("Investments") }}',
                        data: cashFlowData.investments,
                        backgroundColor: '#0ea5e9', // Sky
                        borderRadius: 4,
                        barPercentage: 0.7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, boxWidth: 8, padding: 20 }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)', // White bg
                        titleColor: '#1e293b', // Slate-800
                        bodyColor: '#475569', // Slate-600
                        borderColor: '#e2e8f0', // Slate-200
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function (context) {
                                return context.dataset.label + ': ¥' + Math.abs(context.parsed.y).toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: { borderDash: [4, 4], color: '#f1f5f9' },
                        ticks: {
                            callback: function (value) {
                                return '¥' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Toggle collapsible sections
    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const chevron = document.getElementById(sectionId.replace('Section', 'Chevron'));

        if (section) {
            if (section.style.display === 'none' || getComputedStyle(section).display === 'none') {
                section.style.display = 'block';
                if (chevron) {
                    chevron.classList.remove('fa-chevron-right');
                    chevron.classList.add('fa-chevron-down');
                }
            } else {
                section.style.display = 'none';
                if (chevron) {
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-right');
                }
            }
        }
    }
</script>
{% endblock %}