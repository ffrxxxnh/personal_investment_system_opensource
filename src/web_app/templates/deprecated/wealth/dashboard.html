{% extends "base.html" %}
{% from 'macros/components.html' import metric_card, badge, button, page_header %}

{% block title %}Wealth Overview - WealthOS{% endblock %}

{% block header_title %}
{{ page_header('Wealth Overview', 'Comprehensive analysis of improved net worth and cash flow') }}
{% endblock %}

{% block content %}

<!-- Financial Overview Metrics -->
<div class="dashboard-grid mb-8" style="grid-template-columns: repeat(4, 1fr);">
    {{ metric_card('Net Worth', '--', id='kpi-net-worth', icon='fas fa-wallet', tooltip='Total Assets - Total
    Liabilities') }}
    {{ metric_card('YTD Growth', '--', id='kpi-growth', icon='fas fa-chart-line', tooltip='Annualized growth rate') }}
    {{ metric_card('Savings Rate', '--', id='kpi-savings-rate', icon='fas fa-piggy-bank', tooltip='(Income - Expense) /
    Income') }}
    {{ metric_card('Avg Monthly Flow', '--', id='kpi-net-flow', icon='fas fa-stream', tooltip='Average monthly net cash
    flow') }}
</div>

<!-- Tab Navigation -->
<div class="tabs-container mb-6">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('net-worth', this)">
            <i class="fas fa-chart-line mr-2"></i>Net Worth & Health
        </button>
        <button class="tab-btn" onclick="switchTab('cash-flow', this)">
            <i class="fas fa-exchange-alt mr-2"></i>Cash Flow
        </button>
        <button class="tab-btn" onclick="switchTab('expenses', this)">
            <i class="fas fa-receipt mr-2"></i>Expenses
        </button>
    </div>
</div>

<!-- Tab: Net Worth & Health -->
<div id="tab-net-worth" class="tab-pane active">
    <!-- Trend & Allocation -->
    <div class="dashboard-grid mb-8" style="grid-template-columns: 2fr 1fr;">
        <div class="card">
            <div class="card-header">
                <h3>Net Worth Trend</h3>
            </div>
            <div class="card-body" style="height: 350px; position: relative;">
                <canvas id="chart-net-worth-trend"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h3>Asset Allocation</h3>
            </div>
            <div class="card-body" style="height: 350px; position: relative;">
                <canvas id="chart-asset-allocation"></canvas>
            </div>
        </div>
    </div>

    <!-- Health Ratios -->
    <div class="card mb-8">
        <div class="card-header">
            <h3>Financial Health Ratios</h3>
            {{ badge('Last 24 Months', 'neutral') }}
        </div>
        <div class="card-body" style="height: 300px; position: relative;">
            <canvas id="chart-ratios"></canvas>
        </div>
    </div>
</div>

<!-- Tab: Cash Flow -->
<div id="tab-cash-flow" class="tab-pane" style="display: none;">
    <div class="dashboard-grid mb-8" style="grid-template-columns: 1fr 1fr;">
        <!-- Income vs Expense -->
        <div class="card">
            <div class="card-header">
                <h3>Income vs Expense</h3>
            </div>
            <div class="card-body" style="height: 350px; position: relative;">
                <canvas id="chart-income-expense"></canvas>
            </div>
        </div>
        <!-- Net Cash Flow -->
        <div class="card">
            <div class="card-header">
                <h3>Net Cash Flow</h3>
            </div>
            <div class="card-body" style="height: 350px; position: relative;">
                <canvas id="chart-net-cash-flow"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tab: Expenses -->
<div id="tab-expenses" class="tab-pane" style="display: none;">
    <div class="dashboard-grid mb-8" style="grid-template-columns: 1fr 1fr;">
        <!-- Breakdown -->
        <div class="card">
            <div class="card-header">
                <h3>Expenses by Category</h3>
                {{ badge('Top 6', 'primary') }}
            </div>
            <div class="card-body" style="height: 350px; position: relative;">
                <canvas id="chart-expense-breakdown"></canvas>
            </div>
        </div>
        <!-- Trend -->
        <div class="card">
            <div class="card-header">
                <h3>Essential vs Non-Essential</h3>
            </div>
            <div class="card-body" style="height: 350px; position: relative;">
                <canvas id="chart-expense-trend"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- Styles for Tabs (Inline for now, should move to CSS) ---
    // Actually, I'll rely on the existing style.css updates I made earlier?
    // No, I haven't added specific tab styles yet. I'll add a <style> block here for now
    // or assume I will update style.css in the next step. Let's add block style for safety.
</script>



<script>
    // --- Tab Switching Logic ---
    function switchTab(tabId, btnElement) {
        // Hide all panes
        document.querySelectorAll('.tab-pane').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + tabId).style.display = 'block';

        // Update Buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');

        // Trigger resize for charts to ensure they render correctly in new tab
        window.dispatchEvent(new Event('resize'));
    }

    // --- Chart Config & Data Fetching ---

    // Helper to update card metrics matching the macro structure
    // Helper to update card metrics matching the macro structure
    document.updateMetric = function (id, value) {
        // Since macros now render the ID attribute on the root element, we can select directly.
        const card = document.getElementById(id);
        if (card) {
            const valEl = card.querySelector('.metric-value');
            if (valEl) valEl.textContent = value;
            // Also handle trend/color if needed, but basic value update is here
        }
    };

    // SunnRayy Palette
    const COLORS = {
        gold: '#D4AF37',
        blue: '#00A3E0',
        navy: '#1A365D',
        green: '#10B981',
        red: '#EF4444',
        gray: '#94a3b8',
        purple: '#8B5CF6',
        orange: '#F59E0B'
    };

    // Standard Chart Options
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#64748b';
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'top', labels: { usePointStyle: true, padding: 15 } },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: { label: ctx => ctx.dataset.label + ': ' + formatCurrency(ctx.parsed.y) }
            }
        },
        scales: {
            y: { grid: { borderDash: [2, 4], color: '#f1f5f9' }, ticks: { callback: v => formatCurrencyS(v) } },
            x: { grid: { display: false } }
        }
    };

    // Formatters
    function formatCurrency(val) {
        return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(val);
    }
    function formatCurrencyS(val) {
        if (Math.abs(val) >= 1000000) return '¥' + (val / 1000000).toFixed(1) + 'M';
        if (Math.abs(val) >= 1000) return '¥' + (val / 1000).toFixed(0) + 'k';
        return val;
    }

    // --- Main Logic ---
    document.addEventListener("DOMContentLoaded", fetchData);

    function fetchData() {
        fetch('/wealth/api/summary')
            .then(r => r.json())
            .then(data => {
                if (data.error) { console.error(data.error); return; }
                updateKPIs(data.summary);
                initCharts(data);
            })
            .catch(err => console.error(err));
    }

    function updateKPIs(summary) {
        if (!summary) return;
        document.updateMetric('kpi-net-worth', summary.net_worth);
        document.updateMetric('kpi-growth', summary.net_worth_growth_ytd);
        document.updateMetric('kpi-savings-rate', summary.savings_rate);
        document.updateMetric('kpi-net-flow', summary.monthly_details?.avg_net_cash_flow || '--');
    }

    function initCharts(data) {
        // 1. Net Worth Trend
        if (data.balance_sheet?.trend_chart?.labels) {
            const ctx = document.getElementById('chart-net-worth-trend').getContext('2d');
            const dsNW = data.balance_sheet.trend_chart.datasets.find(d => d.label === 'Net_Worth_Calc_CNY');
            const dsAst = data.balance_sheet.trend_chart.datasets.find(d => d.label === 'Total_Assets_Calc_CNY');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.balance_sheet.trend_chart.labels,
                    datasets: [
                        {
                            label: 'Net Worth',
                            data: dsNW?.data || [],
                            borderColor: COLORS.blue,
                            backgroundColor: 'rgba(0, 163, 224, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Total Assets',
                            data: dsAst?.data || [],
                            borderColor: COLORS.gold,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0
                        }
                    ]
                },
                options: commonOptions
            });
        }

        // 2. Asset Allocation
        if (data.balance_sheet?.asset_allocation?.labels) {
            const ctx = document.getElementById('chart-asset-allocation').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.balance_sheet.asset_allocation.labels,
                    datasets: [{
                        data: data.balance_sheet.asset_allocation.data,
                        backgroundColor: [COLORS.blue, COLORS.gold, COLORS.green, COLORS.purple, COLORS.orange, COLORS.navy, COLORS.red],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        // 3. Health Ratios
        if (data.balance_sheet?.ratios_chart?.labels) {
            const ctx = document.getElementById('chart-ratios').getContext('2d');
            const debtDs = data.balance_sheet.ratios_chart.datasets.find(d => d.label === 'Debt_to_Asset_Ratio');
            const liqDs = data.balance_sheet.ratios_chart.datasets.find(d => d.label === 'Liquidity_Ratio');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.balance_sheet.ratios_chart.labels,
                    datasets: [
                        { label: 'Debt Ratio', data: debtDs?.data, borderColor: COLORS.red, yAxisID: 'y', tension: 0.3 },
                        { label: 'Liquidity', data: liqDs?.data, borderColor: COLORS.green, yAxisID: 'y1', tension: 0.3 }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'Debt %' }, ticks: { callback: v => (v * 100).toFixed(0) + '%' } },
                        y1: { position: 'right', title: { display: true, text: 'Liquidity x' }, grid: { drawOnChartArea: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 4. Income vs Expense
        if (data.cash_flow?.income_chart && data.cash_flow?.expense_chart) {
            const ctx = document.getElementById('chart-income-expense').getContext('2d');
            const incDs = data.cash_flow.income_chart.datasets.find(d => d.label === 'Total_Income_Calc_CNY');
            const expDs = data.cash_flow.expense_chart.datasets.find(d => d.label === 'Total_Expense_Calc_CNY');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.cash_flow.income_chart.labels,
                    datasets: [
                        { label: 'Income', data: incDs.data, backgroundColor: COLORS.green, borderRadius: 4 },
                        { label: 'Expense', data: expDs.data, backgroundColor: COLORS.red, borderRadius: 4 }
                    ]
                },
                options: commonOptions
            });
        }

        // 5. Net Cash Flow
        if (data.cash_flow?.net_cash_flow_chart) {
            const ctx = document.getElementById('chart-net-cash-flow').getContext('2d');
            const ds = data.cash_flow.net_cash_flow_chart.datasets.find(d => d.label === 'Net_Cash_Flow');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.cash_flow.net_cash_flow_chart.labels,
                    datasets: [{
                        label: 'Net Flow',
                        data: ds.data,
                        backgroundColor: ds.data.map(v => v >= 0 ? COLORS.green : COLORS.red),
                        borderRadius: 4
                    }]
                },
                options: commonOptions
            });
        }

        // 6. Expense Breakdown
        if (data.cash_flow?.expense_breakdown) {
            const ctx = document.getElementById('chart-expense-breakdown').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.cash_flow.expense_breakdown.labels,
                    datasets: [{
                        data: data.cash_flow.expense_breakdown.data,
                        backgroundColor: [COLORS.navy, COLORS.blue, COLORS.gold, COLORS.orange, COLORS.purple, COLORS.gray],
                        borderWidth: 0
                    }]
                },
                options: { ...commonOptions, cutout: '0%' } // Full pie
            });
        }

        // 7. Expense Trend
        if (data.cash_flow?.expense_stacked_chart) {
            const ctx = document.getElementById('chart-expense-trend').getContext('2d');
            const datasets = data.cash_flow.expense_stacked_chart.datasets.map((d, i) => ({
                label: d.label.replace('_Expense_Calc', '').replace('_', ' '),
                data: d.data,
                backgroundColor: i === 0 ? COLORS.navy : COLORS.orange,
                borderRadius: 2
            }));

            new Chart(ctx, {
                type: 'bar',
                data: { labels: data.cash_flow.expense_stacked_chart.labels, datasets },
                options: {
                    ...commonOptions,
                    scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true } }
                }
            });
        }
    }
</script>
{% endblock %}